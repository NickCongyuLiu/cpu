<!DOCTYPE html>

<meta charset="utf-8" />

<title>Minieye-web 数据可视化</title>

<script src="echarts.js"></script>
<script type="text/javascript" src="http://ajax.microsoft.com/ajax/jquery/jquery-1.4.min.js"></script>
<script language="javascript" type="text/javascript">

    INTERVAL = setInterval('',1000);

    

    function init(){
        myChart = echarts.init(document.getElementById('chartmain'));
                    var option = {
                        backgroundColor:'white',
                        title:{
                            text:'Minieye数据可视化',
                            subtext:"数据来源：深圳佑驾-Minieye"
                        },
                        visualMap:[{
                            show:false,
                            type:'continuous',
                            seriesIndex:0,
                            min:0,
                            max:400
                        }],
                        toolbox:{
                            show:true,
                            feature:{
                                saveAsImage:{
                                    show:true,
                                    title:'另存为图片',
                                    type:'jpeg',
                                    name:'test'
                                }
                            }
                        },
                        tooltip: {
                            trigger:'axis',
                            show: true,
                        },
                        animation: false,
                        grid:{
                            left:'3%',
                            top:'20%',
                            right:'3%',
                            bottom:'8%',
                            containLabel:true
                        },
                        legend: {
                            data: ['data1']
                        },
                        xAxis: [
                            {   
                                type: 'category',
                                boundaryGap: false,
                                data:[1,2,3,4]
                                
                            }
                        ],
                        yAxis: [
                            {
                                type: 'value',
                                name: '速度(km/h)',
                                // max: 200
                            }
                        ],
                        dataZoom:[                                      //区域缩放  
                            {  
                                id: 'dataZoomX',  
                                show:true,                              //是否显示 组件。如果设置为 false，不会显示，但是数据过滤的功能还存在。  
                                backgroundColor:"rgba(47,69,84,0)",  //组件的背景颜色  
                                type: 'slider',                         //slider表示有滑动块的，inside表示内置的  
                                fillerColor:"rgba(167,183,204,0.4)",  //选中范围的填充颜色。  
                                borderColor:"#ddd",                     //边框颜色。  
                                filterMode: 'filter',                   //'filter'：当前数据窗口外的数据，被 过滤掉。即 会 影响其他轴的数据范围。每个数据项，只要有一个维度在数据窗口外，整个数据项就会被过滤掉。  
                                                                        //'weakFilter'：当前数据窗口外的数据，被 过滤掉。即 会 影响其他轴的数据范围。每个数据项，只有当全部维度都在数据窗口同侧外部，整个数据项才会被过滤掉。  
                                                                        //'empty'：当前数据窗口外的数据，被 设置为空。即 不会 影响其他轴的数据范围。  
                                                                        //'none': 不过滤数据，只改变数轴范围。  
                                start: 0,                                //数据窗口范围的起始百分比,表示30%  
                                end: 100,                                  //数据窗口范围的结束百分比,表示70%  
                                startValue:0,                           //数据窗口范围的起始数值  
                                endValue:100,                            //数据窗口范围的结束数值。  
                                orient:"horizontal",                    //布局方式是横还是竖。不仅是布局方式，对于直角坐标系而言，也决定了，缺省情况控制横向数轴还是纵向数轴。'horizontal'：水平。'vertical'：竖直。  
                                zoomLock:false,                          //是否锁定选择区域（或叫做数据窗口）的大小。如果设置为 true 则锁定选择区域的大小，也就是说，只能平移，不能缩放。  
                                throttle:100,                             //设置触发视图刷新的频率。单位为毫秒（ms）。  
                                zoomOnMouseWheel:true,                  //如何触发缩放。可选值为：true：表示不按任何功能键，鼠标滚轮能触发缩放。false：表示鼠标滚轮不能触发缩放。'shift'：表示按住 shift 和鼠标滚轮能触发缩放。'ctrl'：表示按住 ctrl 和鼠标滚轮能触发缩放。'alt'：表示按住 alt 和鼠标滚轮能触发缩放。  
                                moveOnMouseMove:true,                   //如何触发数据窗口平移。true：表示不按任何功能键，鼠标移动能触发数据窗口平移。false：表示鼠标滚轮不能触发缩放。'shift'：表示按住 shift 和鼠标移动能触发数据窗口平移。'ctrl'：表示按住 ctrl 和鼠标移动能触发数据窗口平移。'alt'：表示按住 alt 和鼠标移动能触发数据窗口平移。  
                                left:"center",                           //组件离容器左侧的距离,'left', 'center', 'right','20%'  
                                top:"auto",                               //组件离容器上侧的距离,'top', 'middle', 'bottom','20%'  
                                right:"auto",                             //组件离容器右侧的距离,'20%'  
                                bottom:"0",                            //组件离容器下侧的距离,'20%'  
                            },
                        ],
                        series: [
                            {   
                                "name": "data1",
                                "type": "line",
                                "data": [5,2,15,3],
                                symbolSize:1,   //拐点圆的大小
                                itemStyle:{
                                    normal:{
                                        color:'#575757'
                                    }
                                },
                                lineStyle:{
                                    normal:{
                                        color:'#575757'
                                    }
                                },
                                // areaStyle:{},
                                // areaStyle:{
                                //     normal:{
                                //         color:'green'
                                //     }
                                // },
                                markPoint:{
                                    symbol:'diamond',
                                    label:true,
                                    color:'#fff',
                                    data:[
                                        {type:'max',name:'data1最大值'},
                                        // {type:'min',name:'最小值'},
                                        {type : 'average', name: 'data2平均值'}
                                    ]
                                }
                            },
                            {
                                "name": "data2",
                                "type": "line",
                                "data": [],
                                symbolSize:1,   //拐点圆的大小
                                itemStyle:{ 
                                    normal:{
                                        // color:'green'
                                    }
                                },
                                lineStyle:{
                                    normal:{
                                        // color:'darkred'
                                    }
                                },
                                // areaStyle:{},
                                // areaStyle:{
                                //     normal:{
                                //         color:'darkred'
                                //     }
                                // },
                                markPoint:{
                                    data:[
                                        {type:'max',name:'data2最大值'},
                                        {type : 'average', name: 'data2平均值'}

                                //         {type:'min',name:'sim_not_inserted最小值'}
                                    ]
                                }
                            },
                            {
                                "name": "data3",
                                "type": "line",
                                "data": [],
                                lineStyle:{
                                    normal:{
                                        color:'green'
                                    }
                                },
                            },
                            {
                                "name": "data4",
                                "type": "line",
                                "data": [],
                                lineStyle:{
                                    normal:{
                                        color:'blue'
                                    }
                                },
                            },
                            {
                                "name": "data5",
                                "type": "line",
                                "data": [],
                            },
                        ]
                    };
        // myChart.showLoading();
        myChart.setOption(option);       
    }

    function drawEcharts(objs){

        var unit = [];
        var number_lines = objs.length;
        var speed_list=[],speed_list_raw=[];
        var f=[],f_raw=[],time=[];


        for(var i = 0;i<objs.length;i++){
            for(var j=0;j<objs[i].data.length;j++){
                objs[i].data[j].push(i);//用i表示不同线段
                unit.push(objs[i].data[j]);
            }
        }

        //根据时间排序
        unit.sort(function(a,b){
           return a[1]-b[1];
        });
        
        //定义文件个数条折现
        for(var i=0;i<number_lines;i++){
            speed_list[i]=new Array();
            speed_list_raw[i]=new Array();
        }
        
        //区分各条折现数值
        for(var i =0;i<unit.length;i++){
            var list_count = unit[i][2];
            f.push(unit[i][1]);
            for(var k =0;k<number_lines;k++){
                if(k==list_count){
                    speed_list[k].push(unit[i][0]);
                }else{
                    speed_list[k].push('-');
                }
            }
        }

       
        //时间处理 一分钟只取一个值
        for(var i=1;i<f.length;i++){
            var dateOne = new Date(Number(f[i-1]));
            var dateTwo = new Date(Number(f[i]));
            if(dateOne.getMinutes()!=dateTwo.getMinutes()){
                f_raw.push(f[i]);
                for(var k =0;k<speed_list.length;k++){
                    speed_list_raw[k].push(speed_list[k][i]);
                }
            }
        }


        for(var i =0;i<speed_list_raw.length;i++){
            for(var k =0;k<speed_list_raw[i].length-1;k++){
                if(speed_list_raw[i][k]=='-'){
                    if(speed_list_raw[i][k-1]!='-' && speed_list_raw[i][k+1]!='-'){
                        speed_list_raw[i][k]=(speed_list_raw[i][k-1]+speed_list_raw[i][k+1])/2;
                    }else{
                        speed_list_raw[i][k]=0;
                    }
                }
            }
        }


        for(var i =0;i<f_raw.length;i++){
            var date = new Date(Number(f_raw[i]));
            var y = (date.getFullYear() + '-');
            var mon = (date.getMonth() + '-');
            var d = (date.getDate() + ' ');
            var h = (date.getHours() < 10 ? '0' + date.getHours() : date.getHours()) + ':';
            var m = (date.getMinutes() <10 ? '0' + date.getMinutes() : date.getMinutes())+ ':';
            var s = (date.getSeconds() <10 ? '0' + date.getSeconds():date.getSeconds());
            time.push(y+mon+d+h+m+s);
        }

        var option = myChart.getOption();
        //设置横坐标纵坐标下载文件名称
        option.xAxis[0].data = time;
        option.series[0].data=[];
        option.series[1].data=[];
        option.series[2].data=[];
        option.series[3].data=[];
        option.series[4].data=[];
        option.legend[0].data=[];
        var name = '';
        for(var i =0;i<number_lines;i++){
            option.series[i].data = speed_list_raw[i];
            option.legend[0].data.push(objs[i].truckno);
            option.series[i].name = objs[i].truckno;
            name = name +objs[i].truckno+' VS ';
        }
        name = name.substring(0,name.length-3);
        option.toolbox[0].feature.saveAsImage.name=name;
        option.title[0].subtext=name+" ";
        myChart.setOption(option);

    }


    function check() {
        
        var objFile = document.getElementById("fileId");
        if(objFile.value == "") {
            alert("请选择你要可视化的文件");
        //多个文件    
        }else{

            var fileString ='';
            var files = $('#fileId').attr('files');
            var objs = [],names=[];

            if(files.length==0){
                alert('文件不能为空');
                return;
            }else if(files.length>5){
                alert('只支持少于5个文件');
                return;
            }
            for(var i =0;i<files.length;i++){
                var file = files[i];
                if(names.length!=0 && file.name.substring(file.name.lastIndexOf('.')+1)!=
                names[names.length-1].substring(names[names.length-1].lastIndexOf('.')+1)){
                    alert("please use same type of file");
                    $('#fileId').val('');
                    return;
                }
                names.push(file.name);
                var reader = new FileReader();
                reader.readAsText(file,"UTF-8");
                reader.onload=function(evt){
                    objs.push(JSON.parse(evt.target.result))
                }
            }
            

            setTimeout(function(){
                data_manipulation(objs,names);
            },1000);
        }
    }


    function data_manipulation(objs,names){

            drawEcharts(objs);
            console.log(objs);
            /*json 数据包格式:
            [data:[speed,timestamp],[speed2,timestamp2]]
            
            */
    }


    
  
  
</script>
<body onload='init()'>

    <div id="chartmain" style="width:2500px; height: 400px;"></div>

    <br>
    <hr>
    <div id='input-line'>
        <input style="margin-left:3%" type="file" multiple="multiple" name = "file" id = "fileId" /> 
        <button  type = "submit" name = "btn"  value = "提交" id = "btnId" onclick="check()" > 提交</button>
    </div>
    <br>
    
        

    
</body>
<style>

    button{
        /* margin:10px 0 0 10px; */
        /* width:100px; */
        box-shadow: none;
        outline: none;
        width:150px;
        text-align:center;
        line-height:100%;
        padding-top:0.5em;
        padding-right:2em;
        padding-bottom:0.55em;
        padding-left:2em;
        font-family:Arial,sans-serif;
        font-size:14px;
        font-style:normal;
        font-variant:normal;
        font-weight:normal;
        text-decoration:none;
        margin-top:0px;
        margin-right:2px;
        margin-bottom:0px;
        margin-left:2px;
        vertical-align:text-bottom;
        display:inline-block;
        cursor:pointer;
        zoom:1;
        outline-width:medium;
        outline-color:invert;
        font-size-adjust:none;
        font-stretch:normal;
        border-top-left-radius:0.5em;
        border-top-right-radius:0.5em;
        border-bottom-left-radius:0.5em;
        border-bottom-right-radius:0.5em;
        box-shadow:0px 1px 2px rgba(0,0,0,0.2);
        text-shadow:0px 1px 1px rgba(0,0,0,0.3);
        /* color:#fefee9; */
        border-top-color:#da7c0c;
        border-right-color:#da7c0c;
        border-bottom-color:#da7c0c;
        border-left-color:#da7c0c;
        border-top-width:1px;
        border-right-width:1px;
        border-bottom-width:1px;
        border-left-width:1px;
        border-top-style:solid;
        border-right-style:solid;
        border-bottom-style:solid;
        border-left-style:solid;
        background-image:none;
        background-attachment:scroll;
        background-repeat:repeat;
        background-position-x:0%;
        background-position-y:0%;
        background-size:auto;
        background-origin:padding-box;
        background-clip:padding-box;
        background-color:none;
    }
    button:nth-of-type(n+1):hover{
        background-color:#f47c20
    }
    
</style>
</html> 